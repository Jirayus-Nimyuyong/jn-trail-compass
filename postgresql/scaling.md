# การปรับขยาย (Scaling) ใน PostgreSQL

## บทนำ

การ **ปรับขยาย (Scaling)** ในระบบฐานข้อมูล PostgreSQL คือกระบวนการในการเพิ่มขนาดหรือประสิทธิภาพของระบบฐานข้อมูลเพื่อรองรับการโหลดงานที่สูงขึ้นหรือการเติบโตของข้อมูล. การปรับขยายสามารถทำได้ทั้งในแนวนอน (horizontal scaling) และในแนวตั้ง (vertical scaling), ซึ่งแต่ละวิธีจะมีข้อดีและข้อเสียที่แตกต่างกัน.

การปรับขยายระบบฐานข้อมูล PostgreSQL สามารถทำได้หลายวิธี เช่น การเพิ่มทรัพยากรของเซิร์ฟเวอร์, การกระจายข้อมูลไปยังหลายๆ เซิร์ฟเวอร์, หรือการใช้เทคนิคต่างๆ เช่น **Sharding** และ **Replication**.

## 1. **Vertical Scaling (การปรับขยายในแนวตั้ง)**

**Vertical Scaling** หมายถึงการเพิ่มทรัพยากรให้กับเซิร์ฟเวอร์ที่ใช้งานอยู่ เช่น การเพิ่ม CPU, RAM, หรือ Storage ให้กับเครื่องเซิร์ฟเวอร์เดียวเพื่อรองรับการโหลดงานที่เพิ่มขึ้น. การปรับขยายในแนวตั้งนี้มักจะเป็นวิธีที่ง่ายที่สุดในการเพิ่มประสิทธิภาพโดยไม่ต้องเปลี่ยนแปลงโครงสร้างของฐานข้อมูล.

### 1.1 **การเพิ่มทรัพยากรใน PostgreSQL**

1. **เพิ่ม RAM**: เพิ่ม RAM จะช่วยให้ PostgreSQL สามารถจัดเก็บข้อมูลในหน่วยความจำได้มากขึ้น, ซึ่งช่วยเพิ่มประสิทธิภาพในการเข้าถึงข้อมูล.
2. **เพิ่ม CPU**: การเพิ่มจำนวนคอร์หรือความเร็วของ CPU จะช่วยให้ PostgreSQL สามารถประมวลผลคำสั่ง SQL ได้เร็วขึ้น.
3. **เพิ่ม Disk Storage**: การเพิ่ม Storage (เช่น SSD) จะช่วยให้การเขียนและอ่านข้อมูลจากดิสก์ทำได้เร็วขึ้น.

### 1.2 **ข้อดีของ Vertical Scaling**

- ง่ายและรวดเร็วในการเพิ่มประสิทธิภาพ.
- ไม่ต้องปรับโครงสร้างของระบบฐานข้อมูลมากนัก.
- เหมาะสำหรับระบบขนาดกลางที่ไม่สามารถแบ่งแยกการโหลดงานได้.

### 1.3 **ข้อเสียของ Vertical Scaling**

- การเพิ่มทรัพยากรเพียงอย่างเดียวอาจไม่เพียงพอเมื่อฐานข้อมูลเติบโตขึ้นอย่างรวดเร็ว.
- เมื่อเซิร์ฟเวอร์ถึงขีดจำกัดแล้ว, การปรับขยายในแนวตั้งจะไม่สามารถช่วยได้อีก.
- มีค่าใช้จ่ายที่สูงเมื่อเพิ่มทรัพยากรที่มีประสิทธิภาพสูง.

## 2. **Horizontal Scaling (การปรับขยายในแนวนอน)**

**Horizontal Scaling** หมายถึงการเพิ่มจำนวนเซิร์ฟเวอร์หรือการกระจายโหลดงานไปยังหลายเครื่อง, ซึ่งช่วยเพิ่มประสิทธิภาพและสามารถรองรับการโหลดงานที่สูงขึ้นได้. การปรับขยายในแนวนอนนี้มักจะใช้ในการปรับขยายระบบฐานข้อมูลขนาดใหญ่.

### 2.1 **Sharding (การแบ่งข้อมูล)**

Sharding คือเทคนิคที่ใช้ในการกระจายข้อมูลไปยังหลายๆ เซิร์ฟเวอร์. ข้อมูลจะถูกแบ่งออกเป็นส่วนๆ (shards) และแต่ละ shard จะถูกเก็บในเซิร์ฟเวอร์ที่แตกต่างกัน. PostgreSQL ไม่มีการสนับสนุนการทำ Sharding ในตัว แต่สามารถใช้เครื่องมือภายนอกหรือวิธีการพิเศษในการทำ Sharding ได้.

#### 2.1.1 **การทำ Sharding ด้วย Citus**

[Citus](https://www.citusdata.com/) เป็นเครื่องมือที่ช่วยให้คุณสามารถทำ Sharding ใน PostgreSQL ได้ง่ายขึ้น. Citus จะช่วยให้คุณกระจายข้อมูลไปยังหลายๆ เซิร์ฟเวอร์และทำการประมวลผลแบบขนาน (parallel processing).

### 2.2 **การใช้ Read Replicas (Replica อ่าน)**

การใช้ **Read Replicas** คือการสร้างฐานข้อมูลสำรอง (Replica) เพื่อรองรับการอ่านข้อมูลจากหลายๆ จุด. ซึ่งช่วยให้สามารถกระจายภาระการอ่านข้อมูลไปยังหลายๆ เซิร์ฟเวอร์ได้. PostgreSQL รองรับการทำ **Streaming Replication** และ **Logical Replication** สำหรับการสร้าง Read Replicas.

### 2.3 **ข้อดีของ Horizontal Scaling**

- สามารถเพิ่มประสิทธิภาพได้โดยการเพิ่มเซิร์ฟเวอร์ใหม่ตามความต้องการ.
- สามารถรองรับโหลดงานที่เพิ่มขึ้นได้โดยการกระจายข้อมูล.
- ระบบสามารถเติบโตได้ในระยะยาว.

### 2.4 **ข้อเสียของ Horizontal Scaling**

- การตั้งค่าและการจัดการที่ซับซ้อนกว่าการปรับขยายในแนวนอน.
- อาจต้องการการออกแบบที่ดีเพื่อหลีกเลี่ยงปัญหาเกี่ยวกับการทำงานร่วมกันของเซิร์ฟเวอร์ (data consistency).
- การทำ Sharding อาจทำให้การทำงานกับข้อมูลบางประเภทซับซ้อนขึ้น.

## 3. **Load Balancing (การกระจายโหลด)**

**Load Balancing** คือการกระจายภาระการทำงานของฐานข้อมูลไปยังหลายๆ เซิร์ฟเวอร์เพื่อให้เซิร์ฟเวอร์แต่ละตัวไม่รับภาระหนักเกินไป. การทำ Load Balancing สามารถใช้ได้ทั้งในรูปแบบของการกระจายคำสั่งการอ่าน (Read) และการเขียน (Write).

### 3.1 **การใช้ PgBouncer สำหรับ Load Balancing**

[PgBouncer](https://pgbouncer.github.io/) เป็นเครื่องมือที่ใช้ในการทำ connection pooling และ Load Balancing สำหรับ PostgreSQL. PgBouncer ช่วยให้การเชื่อมต่อกับฐานข้อมูลทำได้รวดเร็วและสามารถกระจายการเชื่อมต่อไปยังหลายๆ เซิร์ฟเวอร์ได้.

```bash
pgbouncer -u postgres -h localhost
```

### 3.2 **การใช้ HAProxy สำหรับ Load Balancing**

[HAProxy](http://www.haproxy.org/) เป็นเครื่องมือที่นิยมใช้ในการทำ Load Balancing สำหรับฐานข้อมูล PostgreSQL. HAProxy ช่วยในการกระจายโหลดไปยังหลายๆ เซิร์ฟเวอร์และสามารถตรวจสอบสถานะของเซิร์ฟเวอร์เพื่อให้การกระจายโหลดมีประสิทธิภาพ.

## 4. **การตั้งค่าและปรับแต่งสำหรับการปรับขยาย**

### 4.1 **การเพิ่ม `max_connections`**

การปรับค่าของ `max_connections` ใน PostgreSQL จะช่วยให้สามารถรองรับการเชื่อมต่อจากผู้ใช้จำนวนมากขึ้นได้. แต่ต้องระมัดระวังในการตั้งค่านี้เพราะอาจส่งผลกระทบต่อทรัพยากรของเซิร์ฟเวอร์.

```plaintext
max_connections = 500
```

### 4.2 **การเพิ่ม `shared_buffers`**

การเพิ่มค่า `shared_buffers` จะช่วยให้ PostgreSQL ใช้หน่วยความจำสำหรับแคชข้อมูลมากขึ้น, ซึ่งจะช่วยเพิ่มประสิทธิภาพในการเข้าถึงข้อมูล.

```plaintext
shared_buffers = 2GB
```

## 5. **สรุป**

การปรับขยาย (Scaling) ใน PostgreSQL มีทั้งในรูปแบบ **Vertical Scaling** และ **Horizontal Scaling**. การปรับขยายในแนวตั้งจะช่วยเพิ่มประสิทธิภาพของเซิร์ฟเวอร์ที่มีอยู่, ในขณะที่การปรับขยายในแนวนอนสามารถรองรับการโหลดงานที่สูงขึ้นโดยการเพิ่มเซิร์ฟเวอร์และการกระจายข้อมูล. การเลือกวิธีที่เหมาะสมในการปรับขยายขึ้นอยู่กับความต้องการของระบบและปริมาณข้อมูลที่ต้องการจัดการ. 

การใช้เทคนิคต่างๆ เช่น **Sharding**, **Read Replicas**, และ **Load Balancing** ช่วยให้ PostgreSQL สามารถปรับขยายได้อย่างมีประสิทธิภาพและรองรับการเติบโตในระยะยาว.